version: '3.7'

services:
  registry:
    image: registry:2
    ports:
      - "5000:5000/tcp"
    volumes:
      - type: bind
        source: /gmount01/docker/stacks/test/data/registry
        target: /var/lib/registry
    deploy: &deploy_manager
      placement:
        constraints:
          - node.role == manager

  viz:
    image: dockersamples/visualizer
    ports:
      - "8088:8080/tcp"
    volumes:
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
    deploy: *deploy_manager

  web:
    image: nginx
    ports:
     - "8080:80"
    volumes:
      - type: bind
        source: /gmount01/docker/stacks/test/data/web/conf
        target: /etc/nginx/conf.d
      - type: bind
        source: /gmount01/docker/stacks/test/data/web/html
        target: /usr/share/nginx/html
    deploy: &deploy_worker
      replicas: 2
      placement:
        constraints:
          - node.role == worker
    depends_on:
      - php

  php:
    # Note: quay.io images have mysqli pre-installed
    image: quay.io/ignited/php-nginx-fpm:5.6.30-latest
    working_dir: /usr/share/nginx/html
    volumes:
      - type: bind
        source: /gmount01/docker/stacks/test/data/web/html
        target: /usr/share/nginx/html
    deploy: *deploy_worker

  mysql:
    image: mysql
    volumes:
      - type: bind
        source: /gmount01/docker/stacks/test/data/mysql
        target: /var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=mysql
    deploy:
      <<: *deploy_worker
      replicas: 1

  mariadb:
    image: mariadb
    volumes:
      - type: bind
        source: /gmount01/docker/stacks/test/data/mariadb
        target: /var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=mariadb
    deploy:
      <<: *deploy_worker
      replicas: 1

  phpadmin:
    image: phpmyadmin
    ports:
      - "8081:80"
    environment:
      - PMA_ARBITRARY=1
    depends_on:
      - mysql
      - mariadb
    deploy:
      <<: *deploy_worker
      replicas: 1
